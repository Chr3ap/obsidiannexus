<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Listings - Obsidian Nexus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light"> 
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Obsidian Nexus</a>
            <div class="search-container d-flex">
                <i class="fas fa-search search-icon"></i>
                <input class="form-control me-2" type="search" id="search-input" 
                    placeholder="Enter an address, neighborhood, city, or ZIP code" aria-label="Search">
                <button class="btn btn-outline-primary rounded-pill" type="button" onclick="handleSearch()">Search</button>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="darkModeToggle">
                <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
            </div>
        </div>
    </nav>

    <!-- Add this after the navbar -->
    <div class="sidebar-overlay"></div>

    <!-- Add this right after the navbar, before the main content -->
    <div class="map-controls">
        <select id="map-style-switcher" class="form-select form-select-sm">
            <option value="osm">OpenStreetMap</option>
            <option value="satellite">Satellite</option>
            <option value="dark">Dark Mode</option>
        </select>
    </div>

    <!-- Main Content -->
    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Property Listings Sidebar -->
            <div class="col-md-4 col-lg-3 listing-sidebar">
                <div class="listing-header d-md-none">
                    <div class="handle"></div>
                    <h5 class="text-center mb-0">Property Listings</h5>
                </div>
                <div id="desktop-listings-container" class="p-3">
                    <!-- Listings will be dynamically inserted here -->
                </div>
                <div class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="error-message" id="error-message">
                    Unable to load listings. Please try again later.
                </div>
            </div>

            <!-- Map -->
            <div class="col-md-8 col-lg-9">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Mobile Toggle Button -->
    <button class="toggle-view" aria-label="Toggle View">
        <i class="fas fa-list"></i>
    </button>

    <!-- Mobile menu button -->
    <button class="mobile-menu-btn d-md-none" aria-label="Menu">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile menu -->
    <div class="mobile-menu">
        <div class="listing-sidebar">
            <div id="mobile-listings-container" class="p-3">
                <!-- Listings will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let searchTimeout;
        let originalListings = null;
        let currentTileLayer = null;
        let mapStyles;
        
        // Add this function to initialize mapStyles after fetching the API key
        async function initializeMapStyles() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                mapStyles = {
                    osm: {
                        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        options: {
                            attribution: '© OpenStreetMap contributors'
                        }
                    },
                    satellite: {
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        options: {
                            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                        }
                    },
                    dark: {
                        url: `https://tile.jawg.io/jawg-dark/{z}/{x}/{y}{r}.png?access-token=${config.mapApiKey}`,
                        options: {
                            attribution: '<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            minZoom: 0,
                            maxZoom: 22,
                            subdomains: 'abcd'
                        }
                    }
                };
            } catch (error) {
                console.error('Error loading map configuration:', error);
                // Fallback mapStyles if config fails
                mapStyles = {
                    osm: {
                        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        options: {
                            attribution: '© OpenStreetMap contributors'
                        }
                    }
                };
            }
        }

        // Initialize map
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([40.7128, -74.0060], 13);
            
            // Add zoom control to the right
            const zoomControl = L.control.zoom({
                position: 'topright'
            }).addTo(map);

            // Move the zoom control into the map-controls div
            const mapControls = document.querySelector('.map-controls');
            const zoomContainer = document.querySelector('.leaflet-control-zoom');
            mapControls.appendChild(zoomContainer);

            // Set initial map style to dark mode
            setMapStyle('dark');
            
            // Update the style switcher to show dark as selected
            document.getElementById('map-style-switcher').value = 'dark';

            // Add style switcher event listener
            document.getElementById('map-style-switcher').addEventListener('change', (e) => {
                setMapStyle(e.target.value);
            });
        }

        function setMapStyle(styleName) {
            const style = mapStyles[styleName];
            
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            currentTileLayer = L.tileLayer(style.url, style.options).addTo(map);
        }

        // Mobile sidebar toggle functionality
        document.querySelector('.toggle-view')?.addEventListener('click', () => {
            const sidebar = document.querySelector('.listing-sidebar');
            const toggleButton = document.querySelector('.toggle-view i');
            
            sidebar.classList.toggle('expanded');
            toggleButton.classList.toggle('fa-list');
            toggleButton.classList.toggle('fa-times');
            
            // Handle overlay
            let overlay = document.querySelector('.sidebar-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'sidebar-overlay';
                document.body.appendChild(overlay);
                
                // Close sidebar when clicking overlay
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('expanded');
                    toggleButton.classList.remove('fa-times');
                    toggleButton.classList.add('fa-list');
                    overlay.classList.remove('active');
                });
            }
            overlay.classList.toggle('active');
        });

        // Search functionality
        function handleSearch() {
            const searchInput = document.getElementById('search-input');
            const query = searchInput.value.trim();
            
            if (!originalListings) return;
            
            // If query is empty, show all original listings
            if (!query) {
                displayListings(originalListings);
                return;
            }
            
            // Geocode the location
            geocodeLocation(query);
            
            // Filter listings
            const filteredFeatures = originalListings.features.filter(feature => {
                const prop = feature.properties;
                const searchString = `${prop.location_name} ${prop.city} ${prop.state} ${prop.zipcode}`.toLowerCase();
                return searchString.includes(query.toLowerCase());
            });
            
            displayListings({
                type: "FeatureCollection",
                features: filteredFeatures
            });
        }
        
        // Debounced search input handler
        document.getElementById('search-input').addEventListener('input', debounce(handleSearch, 500));

        // Fetch and display listings with loading state
        async function fetchListings() {
            const loadingOverlay = document.querySelector('.loading-overlay');
            const errorMessage = document.getElementById('error-message');
            const desktopContainer = document.getElementById('desktop-listings-container');
            const mobileContainer = document.getElementById('mobile-listings-container');
            
            try {
                loadingOverlay.style.display = 'block';
                errorMessage.style.display = 'none';
                desktopContainer.innerHTML = '';
                mobileContainer.innerHTML = '';
                
                const response = await fetch('/api/listings');
                if (!response.ok) throw new Error('Failed to fetch listings');
                
                const data = await response.json();
                originalListings = data; // Store original listings
                
                if (!data.features || data.features.length === 0) {
                    const noListingsMessage = 'No listings found.';
                    errorMessage.textContent = noListingsMessage;
                    errorMessage.style.display = 'block';
                    return;
                }
                
                displayListings(data);
                errorMessage.style.display = 'none';
                
            } catch (error) {
                console.error('Error fetching listings:', error);
                errorMessage.style.display = 'block';
                desktopContainer.innerHTML = '';
                mobileContainer.innerHTML = '';
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // Display listings on both the sidebar and map
        function displayListings(geojson) {
            const desktopContainer = document.getElementById('desktop-listings-container');
            const mobileContainer = document.getElementById('mobile-listings-container');
            desktopContainer.innerHTML = '';
            mobileContainer.innerHTML = '';

            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (!geojson.features || !geojson.features.length) {
                const noResults = '<div class="alert alert-info">No properties found.</div>';
                desktopContainer.innerHTML = noResults;
                mobileContainer.innerHTML = noResults;
                return;
            }

            geojson.features.forEach((feature, index) => {
                const properties = feature.properties;
                const coordinates = feature.geometry.coordinates;

                // Create custom marker icon with color based on availability
                const markerColor = properties.availability ? '#00C851' : '#ff4444';
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: 12px;
                        height: 12px;
                        background-color: ${markerColor};
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 0 4px rgba(0,0,0,0.3);
                    "></div>`,
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });

                // Add marker to map
                const marker = L.marker([coordinates[1], coordinates[0]], { icon })
                    .bindPopup(createPopupContent(properties), {
                        closeButton: true,
                        closeOnClick: true,
                        autoClose: true
                    })
                    .addTo(map);
                
                // Remove the click event that highlights the card
                marker.on('click', () => {
                    marker.openPopup();
                });
                
                // Add popup close event
                marker.on('popupclose', () => {
                    // Optional: deselect the card when popup closes
                    const cards = document.querySelectorAll('.property-card');
                    cards.forEach(card => card.classList.remove('active'));
                });
                
                markers.push(marker);

                // Add listing card to both containers
                const cardHtml = createListingCard(properties, index);
                desktopContainer.innerHTML += cardHtml;
                mobileContainer.innerHTML += cardHtml;
            });

            // Fit map bounds to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds(), {
                    padding: [50, 50]
                });
            }
        }

        function highlightCard(index) {
            const cards = document.querySelectorAll('.property-card');
            cards.forEach(card => card.classList.remove('active'));
            cards[index]?.classList.add('active');
            cards[index]?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function createPopupContent(properties) {
            const formattedPrice = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(properties.price);

            return `
                <div class="popup-content">
                    <h6>${formattedPrice}</h6>
                    <p>${properties.location_name}</p>
                    <p>${properties.bedrooms} bd • ${properties.bathrooms} ba • ${properties.sq_footage.toLocaleString()} sf</p>
                    <small class="text-muted">${properties.year_built} • ${properties.county}</small>
                </div>
            `;
        }

        function createListingCard(properties, index) {
            const formattedPrice = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(properties.price);

            const statusClass = properties.availability ? 'status-available' : 'status-sold';
            const statusText = properties.availability ? 'Available' : properties.status;

            return `
                <div class="card property-card" onclick="focusListing(${index})">
                    <div class="card-body">
                        <span class="property-status ${statusClass}">${statusText}</span>
                        <div class="property-info">
                            <div class="property-price">${formattedPrice}</div>
                            <div class="property-address">${properties.location_name}</div>
                        </div>
                        
                        <div class="property-details">
                            <div class="detail-item">
                                <div class="detail-value">${properties.bedrooms}</div>
                                <div class="detail-label">Beds</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${properties.bathrooms}</div>
                                <div class="detail-label">Baths</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${properties.sq_footage.toLocaleString()}</div>
                                <div class="detail-label">Sq.Ft</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${properties.year_built}</div>
                                <div class="detail-label">Year</div>
                            </div>
                        </div>

                        <div class="property-description">${properties.description || ''}</div>
                        
                        <a href="${properties.link}" target="_blank" class="btn btn-outline-primary btn-sm btn-view-details" 
                           onclick="event.stopPropagation()">
                            View Details
                        </a>
                    </div>
                </div>
            `;
        }

        function focusListing(index) {
            const marker = markers[index];
            map.setView(marker.getLatLng(), 16);
            marker.openPopup();
            
            // Close mobile menu when a listing is selected
            if (window.innerWidth <= 768) {
                const menu = document.querySelector('.mobile-menu');
                const btn = document.querySelector('.mobile-menu-btn');
                menu.classList.remove('active');
                btn.querySelector('i').classList.remove('fa-times');
                btn.querySelector('i').classList.add('fa-bars');
            }
            
            highlightCard(index);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            map.invalidateSize();
        });

        // Initialize the application
        window.onload = async function() {
            await initializeMapStyles();
            initMap();
            fetchListings();
            enableDarkMode();
            document.getElementById('darkModeToggle').checked = true;
        };

        function applyFilters() {
            if (!originalListings) return;
            
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            const priceRange = document.getElementById('price-filter').value;
            const minBeds = document.getElementById('beds-filter').value;
            const status = document.getElementById('status-filter').value;
            
            let filteredFeatures = originalListings.features.filter(feature => {
                const prop = feature.properties;
                let matches = true;
                
                // Search filter
                if (searchQuery) {
                    const searchable = `${prop.location_name} ${prop.city} ${prop.state} ${prop.zipcode}`.toLowerCase();
                    matches = matches && searchable.includes(searchQuery);
                }
                
                // Price filter
                if (priceRange) {
                    const [min, max] = priceRange.split('-').map(Number);
                    if (max) {
                        matches = matches && prop.price >= min && prop.price <= max;
                    } else {
                        matches = matches && prop.price >= min;
                    }
                }
                
                // Beds filter
                if (minBeds) {
                    matches = matches && prop.bedrooms >= Number(minBeds);
                }
                
                // Status filter
                if (status) {
                    matches = matches && prop.status === status;
                }
                
                return matches;
            });
            
            displayListings({
                type: "FeatureCollection",
                features: filteredFeatures
            });
        }

        // Add event listeners for filters
        document.getElementById('search-input').addEventListener('input', debounce(applyFilters, 500));
        document.getElementById('price-filter').addEventListener('change', applyFilters);
        document.getElementById('beds-filter').addEventListener('change', applyFilters);
        document.getElementById('status-filter').addEventListener('change', applyFilters);

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            document.querySelector('.navbar').classList.add('dark-mode');
            document.querySelector('.listing-sidebar').classList.add('dark-mode');
            document.querySelectorAll('.property-card').forEach(card => card.classList.add('dark-mode'));
            document.querySelectorAll('.form-control, .form-select').forEach(input => input.classList.add('dark-mode'));
            document.querySelector('.map-controls').classList.add('dark-mode');
            document.querySelector('.toggle-view').classList.add('dark-mode');
            document.querySelectorAll('.btn-outline-primary').forEach(btn => btn.classList.add('dark-mode'));
        }

        document.getElementById('darkModeToggle').addEventListener('change', function() {
            const isDarkMode = this.checked;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.querySelector('.navbar').classList.toggle('dark-mode', isDarkMode);
            document.querySelector('.listing-sidebar').classList.toggle('dark-mode', isDarkMode);
            document.querySelectorAll('.property-card').forEach(card => {
                card.classList.toggle('dark-mode', isDarkMode);
            });
            document.querySelectorAll('.form-control, .form-select').forEach(input => {
                input.classList.toggle('dark-mode', isDarkMode);
            });
            document.querySelector('.map-controls').classList.toggle('dark-mode', isDarkMode);
            document.querySelector('.toggle-view')?.classList.toggle('dark-mode', isDarkMode);
            document.querySelectorAll('.btn-outline-primary').forEach(btn => {
                btn.classList.toggle('dark-mode', isDarkMode);
            });

            // Update map style based on dark mode
            if (isDarkMode) {
                setMapStyle('dark');
                document.getElementById('map-style-switcher').value = 'dark';
            } else {
                setMapStyle('osm');
                document.getElementById('map-style-switcher').value = 'osm';
            }
        });

        // Add this function after the handleSearch function
        async function geocodeLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const location = data[0];
                    map.setView([location.lat, location.lon], 13);
                    
                    // Optional: Add a temporary marker at the searched location
                    const searchMarker = L.marker([location.lat, location.lon], {
                        icon: L.divIcon({
                            className: 'search-marker',
                            html: `<div style="
                                width: 16px;
                                height: 16px;
                                background-color: #006AFF;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 0 4px rgba(0,0,0,0.3);
                            "></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map);
                    
                    // Remove the marker after 5 seconds
                    setTimeout(() => {
                        map.removeLayer(searchMarker);
                    }, 5000);
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
        }

        // Add this right after your map initialization code
        window.addEventListener('load', function() {
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const mobileMenu = document.querySelector('.mobile-menu');
            
            if (mobileMenuBtn && mobileMenu) {
                console.log('Mobile menu elements found'); // Debug log
                
                mobileMenuBtn.addEventListener('click', function(e) {
                    console.log('Mobile menu button clicked'); // Debug log
                    e.preventDefault();
                    e.stopPropagation();
                    
                    mobileMenu.classList.toggle('active');
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.toggle('fa-bars');
                        icon.classList.toggle('fa-times');
                    }
                });
            } else {
                console.log('Mobile menu elements not found:', { 
                    btn: mobileMenuBtn, 
                    menu: mobileMenu 
                }); // Debug log
            }
        });
    </script>
</body>
</html> 