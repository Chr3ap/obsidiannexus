<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Listings - Obsidian Nexus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light"> 
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Obsidian Nexus</a>
            <div class="search-container d-flex">
                <i class="fas fa-search search-icon"></i>
                <input class="form-control me-2" type="search" id="search-input" 
                    placeholder="Enter an address, neighborhood, city, or ZIP code" aria-label="Search">
                <button class="btn btn-outline-primary rounded-pill" type="button" onclick="handleSearch()">Search</button>
            </div>
            <div class="filters-container">
                <select id="price-filter" class="form-select form-select-sm">
                    <option value="">Price (Any)</option>
                    <option value="0-100000">Under $100k</option>
                    <option value="100000-200000">$100k - $200k</option>
                    <option value="200000-300000">$200k - $300k</option>
                    <option value="300000-500000">$300k - $500k</option>
                    <option value="500000">$500k+</option>
                </select>
                
                <select id="beds-filter" class="form-select form-select-sm">
                    <option value="">Beds (Any)</option>
                    <option value="1">1+</option>
                    <option value="2">2+</option>
                    <option value="3">3+</option>
                    <option value="4">4+</option>
                    <option value="5">5+</option>
                </select>
                
                <select id="status-filter" class="form-select form-select-sm">
                    <option value="">Status (Any)</option>
                    <option value="For Sale">For Sale</option>
                    <option value="Sold">Sold</option>
                </select>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="darkModeToggle">
                <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
            </div>
        </div>
    </nav>

    <!-- Add this after the navbar -->
    <div class="sidebar-overlay"></div>

    <!-- Add this right after the navbar, before the main content -->
    <div class="map-controls">
        <select id="map-style-switcher" class="form-select form-select-sm">
            <option value="osm">OpenStreetMap</option>
            <option value="satellite">Satellite</option>
            <option value="dark">Dark Mode</option>
        </select>
    </div>

    <!-- Main Content -->
    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Property Listings Sidebar -->
            <div class="col-md-4 col-lg-3 listing-sidebar">
                <div class="listing-header d-md-none">
                    <div class="handle"></div>
                    <h5 class="text-center mb-0">Property Listings</h5>
                </div>
                <div id="desktop-listings-container" class="p-3">
                    <!-- Listings will be dynamically inserted here -->
                </div>
                <div class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="progress mt-2">Loading properties...</div>
                </div>
                <div class="error-message" id="error-message">
                    Unable to load listings. Please try again later.
                </div>
            </div>

            <!-- Map -->
            <div class="col-md-8 col-lg-9">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Mobile Toggle Button -->
    <button class="toggle-view" aria-label="Toggle View">
        <i class="fas fa-list"></i>
    </button>

    <!-- Mobile menu button -->
    <button class="mobile-menu-btn d-md-none" aria-label="Menu">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile menu -->
    <div class="mobile-menu">
        <div class="listing-sidebar">
            <div id="mobile-listings-container" class="p-3">
                <!-- Listings will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="/js/utils.js"></script>
    <script>
        let map;
        let markers = [];
        let searchTimeout;
        let originalListings = null;
        let currentTileLayer = null;
        let mapStyles;
        let markerClusterGroup;
        
        // Add this function to initialize mapStyles after fetching the API key
        async function initializeMapStyles() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                mapStyles = {
                    osm: {
                        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        options: {
                            attribution: '© OpenStreetMap contributors'
                        }
                    },
                    satellite: {
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        options: {
                            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                        }
                    },
                    dark: {
                        url: `https://tile.jawg.io/jawg-dark/{z}/{x}/{y}{r}.png?access-token=${config.mapApiKey}`,
                        options: {
                            attribution: '<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            minZoom: 0,
                            maxZoom: 22,
                            subdomains: 'abcd'
                        }
                    }
                };
            } catch (error) {
                console.error('Error loading map configuration:', error);
                // Fallback mapStyles if config fails
                mapStyles = {
                    osm: {
                        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        options: {
                            attribution: '© OpenStreetMap contributors'
                        }
                    }
                };
            }
        }

        // Initialize map
        function initMap() {
            try {
                console.log('Initializing map');
                map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false,
                    preferCanvas: true,
                    wheelDebounceTime: 150,
                    wheelPxPerZoomLevel: 120,
                    tap: false,
                    bounceAtZoomLimits: false
                });

                // Set initial view to continental US
                map.setView([39.8283, -98.5795], 4);
                
                // Add zoom control to the right
                const zoomControl = L.control.zoom({
                    position: 'topright'
                }).addTo(map);

                // Move the zoom control into the map-controls div
                const mapControls = document.querySelector('.map-controls');
                const zoomContainer = document.querySelector('.leaflet-control-zoom');
                if (mapControls && zoomContainer) {
                    mapControls.appendChild(zoomContainer);
                }

                // Set initial map style
                setMapStyle('dark');
                
                // Add clustering for markers
                markerClusterGroup = L.markerClusterGroup({
                    chunkedLoading: true,
                    maxClusterRadius: 50,
                    spiderfyOnMaxZoom: false,
                    disableClusteringAtZoom: 16,
                    animate: false
                });
                
                map.addLayer(markerClusterGroup);

                // Add map load event listener
                map.on('load', () => {
                    console.log('Map loaded');
                });
                
                console.log('Map initialized successfully');
                return true;
            } catch (error) {
                console.error('Map initialization failed:', error);
                const errorMessage = document.getElementById('error-message');
                if (errorMessage) {
                    errorMessage.textContent = 'Failed to initialize map. Please refresh the page.';
                    errorMessage.style.display = 'block';
                }
                return false;
            }
        }

        function setMapStyle(styleName) {
            const style = mapStyles[styleName];
            
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            currentTileLayer = L.tileLayer(style.url, style.options).addTo(map);
        }

        // Mobile sidebar toggle functionality
        document.querySelector('.toggle-view')?.addEventListener('click', () => {
            const sidebar = document.querySelector('.listing-sidebar');
            const toggleButton = document.querySelector('.toggle-view i');
            
            sidebar.classList.toggle('expanded');
            toggleButton.classList.toggle('fa-list');
            toggleButton.classList.toggle('fa-times');
            
            // Handle overlay
            let overlay = document.querySelector('.sidebar-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'sidebar-overlay';
                document.body.appendChild(overlay);
                
                // Close sidebar when clicking overlay
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('expanded');
                    toggleButton.classList.remove('fa-times');
                    toggleButton.classList.add('fa-list');
                    overlay.classList.remove('active');
                });
            }
            overlay.classList.toggle('active');
        });

        // Search functionality
        function handleSearch() {
            const searchInput = document.getElementById('search-input');
            const query = searchInput.value.trim();
            
            if (!originalListings) return;
            
            // If query is empty, show all original listings
            if (!query) {
                displayListings(originalListings);
                return;
            }
            
            // Geocode the location
            geocodeLocation(query);
            
            // Filter listings
            const filteredFeatures = originalListings.features.filter(feature => {
                const prop = feature.properties;
                const searchString = `${prop.location_name} ${prop.city} ${prop.state} ${prop.zipcode}`.toLowerCase();
                return searchString.includes(query.toLowerCase());
            });
            
            displayListings({
                type: "FeatureCollection",
                features: filteredFeatures
            });
        }
        
        // Debounced search input handler
        document.getElementById('search-input').addEventListener('input', debounce(handleSearch, 500));

        // Fetch and display listings with loading state
        function fetchListings() {
            const loadingOverlay = document.querySelector('.loading-overlay');
            const errorMessage = document.getElementById('error-message');
            const desktopContainer = document.getElementById('desktop-listings-container');
            const mobileContainer = document.getElementById('mobile-listings-container');
            
            let processedCount = 0;
            const BATCH_SIZE = 10; // Process 10 listings at a time
            
            return new Promise(async (resolve, reject) => {
                try {
                    loadingOverlay.style.display = 'flex';
                    errorMessage.style.display = 'none';
                    
                    // Clear existing containers
                    desktopContainer.innerHTML = '';
                    mobileContainer.innerHTML = '';
                    
                    // Clear existing markers
                    if (markerClusterGroup) {
                        markerClusterGroup.clearLayers();
                    }
                    markers = [];
                    
                    let validMarkers = [];
                    let bounds = L.latLngBounds();

                    await loadGeoJsonInChunks('/api/listings', async (chunk) => {
                        // Filter for available properties
                        const availableFeatures = chunk.features.filter(feature => 
                            feature.properties.status === "For Sale" && 
                            feature.geometry?.coordinates
                        );

                        // Process in smaller batches
                        for (let i = 0; i < availableFeatures.length; i += BATCH_SIZE) {
                            const batch = availableFeatures.slice(i, i + BATCH_SIZE);
                            
                            await new Promise(resolve => setTimeout(resolve, 0)); // Let UI breathe
                            
                            batch.forEach(feature => {
                                try {
                                    const propertyData = {
                                        ...feature.properties,
                                        property_id: feature.properties.property_id,
                                        location_name: feature.properties.location_name,
                                        price: feature.properties.price,
                                        status: feature.properties.status,
                                        bedrooms: feature.properties.bedrooms,
                                        bathrooms: feature.properties.bathrooms,
                                        sq_footage: feature.properties.sq_footage,
                                        year_built: feature.properties.year_built,
                                        city: feature.properties.city,
                                        state: feature.properties.state,
                                        county: feature.properties.county,
                                        zipcode: feature.properties.zipcode,
                                        deal_type: feature.properties.deal_type
                                    };

                                    const marker = createMarker(feature.geometry.coordinates, propertyData);
                                    if (marker) {
                                        validMarkers.push(marker);
                                        bounds.extend(marker.getLatLng());
                                        
                                        const cardHtml = createListingCard(propertyData, processedCount++);
                                        desktopContainer.insertAdjacentHTML('beforeend', cardHtml);
                                        mobileContainer.insertAdjacentHTML('beforeend', cardHtml);
                                    }
                                } catch (error) {
                                    console.error('Error processing feature:', error);
                                }
                            });

                            // Update loading progress
                            const progress = document.querySelector('.loading-overlay .progress');
                            if (progress) {
                                progress.textContent = `Loading properties... ${processedCount} loaded`;
                            }
                        }
                    });

                    // Update markers array with valid markers
                    markers = validMarkers;

                    // Fit map to bounds if we have markers
                    if (markers.length > 0) {
                        map.fitBounds(bounds);
                    }

                    resolve();
                } catch (error) {
                    console.error('Error in fetchListings:', error);
                    errorMessage.textContent = error.message;
                    errorMessage.style.display = 'block';
                    reject(error);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            });
        }

        // Display listings on both the sidebar and map
        function displayListings(geojson) {
            console.log('displayListings called with:', {
                type: geojson?.type,
                featureCount: geojson?.features?.length
            });
            
            const desktopContainer = document.getElementById('desktop-listings-container');
            const mobileContainer = document.getElementById('mobile-listings-container');
            
            if (!desktopContainer || !mobileContainer) {
                console.error('Containers not found:', {
                    desktop: !!desktopContainer,
                    mobile: !!mobileContainer
                });
                return;
            }

            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (!geojson?.features?.length) {
                console.warn('No features in GeoJSON data');
                const noResults = '<div class="alert alert-info">No properties available.</div>';
                desktopContainer.innerHTML = noResults;
                mobileContainer.innerHTML = noResults;
                return;
            }

            // Clear existing containers
            desktopContainer.innerHTML = '';
            mobileContainer.innerHTML = '';

            geojson.features.forEach((feature, index) => {
                try {
                    if (!feature.geometry?.coordinates || !feature.properties) {
                        console.error('Invalid feature:', feature);
                        return;
                    }

                    // Create a complete properties object
                    const propertyData = {
                        ...feature.properties,  // Spread all existing properties
                        property_id: feature.properties.property_id,
                        location_name: feature.properties.location_name,
                        price: feature.properties.price,
                        status: feature.properties.status,
                        bedrooms: feature.properties.bedrooms,
                        bathrooms: feature.properties.bathrooms,
                        sq_footage: feature.properties.sq_footage,
                        year_built: feature.properties.year_built,
                        city: feature.properties.city,
                        state: feature.properties.state,
                        county: feature.properties.county,
                        zipcode: feature.properties.zipcode,
                        deal_type: feature.properties.deal_type
                    };

                    console.log('Complete property data:', propertyData);

                    const marker = createMarker(feature.geometry.coordinates, propertyData);
                    if (marker) {
                        markers.push(marker);
                        const cardHtml = createListingCard(propertyData, index);
                        desktopContainer.insertAdjacentHTML('beforeend', cardHtml);
                        mobileContainer.insertAdjacentHTML('beforeend', cardHtml);
                    }
                } catch (error) {
                    console.error('Error processing feature:', error, feature);
                }
            });

            // Fit map to markers
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds());
            } else {
                console.warn('No markers to fit bounds to');
            }
        }

        function highlightCard(index) {
            const cards = document.querySelectorAll('.property-card');
            cards.forEach(card => card.classList.remove('active'));
            cards[index]?.classList.add('active');
            cards[index]?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function createPopupContent(properties) {
            if (!properties) {
                console.error('No properties provided for popup content');
                return '';
            }

            try {
                // Handle N/A or invalid price
                const price = properties.price === "N/A" || !properties.price ? 0 : properties.price;
                const formattedPrice = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(price);

                // Handle status styling
                const statusClass = properties.status === "Sold" ? 'status-sold' : 
                                   properties.status === "For Sale" ? 'status-available' : 
                                   'status-pending';
                const statusText = properties.status || 'Unknown';

                // Handle property details with proper null checks
                const bedrooms = properties.bedrooms ? Number(properties.bedrooms) : '-';
                const bathrooms = properties.bathrooms ? Number(properties.bathrooms) : '-';
                const sqFootage = properties.sq_footage ? 
                    new Intl.NumberFormat('en-US').format(Number(properties.sq_footage)) : '-';

                return `
                    <div class="card property-card popup-card">
                        <div class="card-body">
                            <span class="property-status ${statusClass}">${statusText}</span>
                            <div class="property-info">
                                <div class="property-price">${formattedPrice}</div>
                                <div class="property-address">${properties.location_name}</div>
                            </div>
                            
                            <div class="property-details">
                                <div class="detail-item">
                                    <div class="detail-value">${bedrooms}</div>
                                    <div class="detail-label">Beds</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-value">${bathrooms}</div>
                                    <div class="detail-label">Baths</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-value">${sqFootage}</div>
                                    <div class="detail-label">Sq.Ft</div>
                                </div>
                            </div>

                            <div class="property-meta">
                                <div class="meta-item">
                                    <i class="fas fa-map-marker-alt"></i> ${properties.city}, ${properties.state} ${properties.zipcode || ''}
                                </div>
                                ${properties.county ? `
                                    <div class="meta-item">
                                        <i class="fas fa-home"></i> ${properties.county}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error creating popup content:', error);
                return '';
            }
        }

        function createListingCard(properties, index) {
            if (!properties) {
                console.error('No properties provided for card creation');
                return '';
            }

            try {
                // Handle N/A or invalid price
                const price = properties.price === "N/A" || !properties.price ? 0 : properties.price;
                const formattedPrice = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(price);

                // Extract location data
                const location = properties.location_name;
                const { city, state, zipcode } = parseLocationString(location);
                const county = properties.county || '';

                // Handle status styling
                const statusClass = properties.status === "Sold" ? 'status-sold' : 
                                   properties.status === "For Sale" ? 'status-available' : 
                                   'status-pending';
                const statusText = properties.status || 'Unknown';

                // Handle property details with proper null checks
                const bedrooms = properties.bedrooms ? Number(properties.bedrooms) : '-';
                const bathrooms = properties.bathrooms ? Number(properties.bathrooms) : '-';
                const sqFootage = properties.sq_footage ? 
                    new Intl.NumberFormat('en-US').format(Number(properties.sq_footage)) : '-';

                return `
                    <div class="card property-card" onclick="focusListing(${index})">
                        <div class="card-body">
                            <span class="property-status ${statusClass}">${statusText}</span>
                            <div class="property-info">
                                <div class="property-price">${formattedPrice}</div>
                                <div class="property-address">${location}</div>
                            </div>
                            
                            <div class="property-details">
                                <div class="detail-item">
                                    <div class="detail-value">${bedrooms}</div>
                                    <div class="detail-label">Beds</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-value">${bathrooms}</div>
                                    <div class="detail-label">Baths</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-value">${sqFootage}</div>
                                    <div class="detail-label">Sq.Ft</div>
                                </div>
                            </div>

                            <div class="property-meta">
                                <div class="meta-item">
                                    <i class="fas fa-map-marker-alt"></i> ${city}, ${state} ${zipcode}
                                </div>
                                ${county ? `
                                    <div class="meta-item">
                                        <i class="fas fa-home"></i> ${county}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error creating listing card:', error);
                return '';
            }
        }

        function focusListing(index) {
            const marker = markers[index];
            
            if (window.innerWidth <= 768) {
                const menu = document.querySelector('.mobile-menu');
                const btn = document.querySelector('.mobile-menu-btn');
                
                menu.classList.add('transparent');
                
                setTimeout(() => {
                    menu.classList.remove('active', 'transparent');
                    const icon = btn.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                    
                    map.setView(marker.getLatLng(), 16, {
                        animate: true,
                        duration: 1
                    });
                    marker.openPopup();
                }, 300);
            } else {
                map.setView(marker.getLatLng(), 16, {
                    animate: true,
                    duration: 1
                });
                marker.openPopup();
            }
            
            highlightCard(index);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            map.invalidateSize();
        });

        // Initialize the application
        window.onload = async function() {
            try {
                console.log('Starting application initialization');
                await initializeMapStyles();
                
                if (!initMap()) {
                    throw new Error('Map initialization failed');
                }
                
                console.log('Map initialized, fetching listings');
                await fetchListings();
                
                enableDarkMode();
                document.getElementById('darkModeToggle').checked = true;
                
                // Add filter event listeners
                const searchInput = document.getElementById('search-input');
                const priceFilter = document.getElementById('price-filter');
                const bedsFilter = document.getElementById('beds-filter');
                const statusFilter = document.getElementById('status-filter');

                if (searchInput) searchInput.addEventListener('input', debounce(applyFilters, 500));
                if (priceFilter) priceFilter.addEventListener('change', applyFilters);
                if (bedsFilter) bedsFilter.addEventListener('change', applyFilters);
                if (statusFilter) statusFilter.addEventListener('change', applyFilters);
                
                console.log('Application initialization complete');
            } catch (error) {
                console.error('Error during initialization:', error);
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = 'Error loading application. Please try refreshing the page.';
                errorMessage.style.display = 'block';
            }
        };

        function applyFilters() {
            if (!originalListings) return;
            
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            const priceRange = document.getElementById('price-filter').value;
            const minBeds = document.getElementById('beds-filter').value;
            const status = document.getElementById('status-filter').value;
            
            let filteredFeatures = originalListings.features.filter(feature => {
                const prop = feature.properties;
                let matches = true;
                
                // Search filter
                if (searchQuery) {
                    const searchable = `${prop.location_name} ${prop.city} ${prop.state} ${prop.zipcode}`.toLowerCase();
                    matches = matches && searchable.includes(searchQuery);
                }
                
                // Price filter
                if (priceRange) {
                    const [min, max] = priceRange.split('-').map(Number);
                    if (max) {
                        matches = matches && prop.price >= min && prop.price <= max;
                    } else {
                        matches = matches && prop.price >= min;
                    }
                }
                
                // Beds filter
                if (minBeds) {
                    matches = matches && prop.bedrooms >= Number(minBeds);
                }
                
                // Status filter
                if (status) {
                    matches = matches && prop.status === status;
                }
                
                return matches;
            });
            
            displayListings({
                type: "FeatureCollection",
                features: filteredFeatures
            });
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            document.querySelector('.navbar').classList.add('dark-mode');
            document.querySelector('.listing-sidebar').classList.add('dark-mode');
            document.querySelectorAll('.property-card').forEach(card => card.classList.add('dark-mode'));
            document.querySelectorAll('.form-control, .form-select').forEach(input => input.classList.add('dark-mode'));
            document.querySelector('.map-controls').classList.add('dark-mode');
            document.querySelector('.toggle-view').classList.add('dark-mode');
            document.querySelectorAll('.btn-outline-primary').forEach(btn => btn.classList.add('dark-mode'));
        }

        document.getElementById('darkModeToggle').addEventListener('change', function() {
            const isDarkMode = this.checked;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.querySelector('.navbar').classList.toggle('dark-mode', isDarkMode);
            document.querySelector('.listing-sidebar').classList.toggle('dark-mode', isDarkMode);
            document.querySelectorAll('.property-card').forEach(card => {
                card.classList.toggle('dark-mode', isDarkMode);
            });
            document.querySelectorAll('.form-control, .form-select').forEach(input => {
                input.classList.toggle('dark-mode', isDarkMode);
            });
            document.querySelector('.map-controls').classList.toggle('dark-mode', isDarkMode);
            document.querySelector('.toggle-view')?.classList.toggle('dark-mode', isDarkMode);
            document.querySelectorAll('.btn-outline-primary').forEach(btn => {
                btn.classList.toggle('dark-mode', isDarkMode);
            });

            // Update map style based on dark mode
            if (isDarkMode) {
                setMapStyle('dark');
                document.getElementById('map-style-switcher').value = 'dark';
            } else {
                setMapStyle('osm');
                document.getElementById('map-style-switcher').value = 'osm';
            }
        });

        // Add this function after the handleSearch function
        async function geocodeLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const location = data[0];
                    map.setView([location.lat, location.lon], 13);
                    
                    // Optional: Add a temporary marker at the searched location
                    const searchMarker = L.marker([location.lat, location.lon], {
                        icon: L.divIcon({
                            className: 'search-marker',
                            html: `<div style="
                                width: 16px;
                                height: 16px;
                                background-color: #006AFF;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 0 4px rgba(0,0,0,0.3);
                            "></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map);
                    
                    // Remove the marker after 5 seconds
                    setTimeout(() => {
                        map.removeLayer(searchMarker);
                    }, 5000);
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
        }

        // Add this right after your map initialization code
        window.addEventListener('load', function() {
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const mobileMenu = document.querySelector('.mobile-menu');
            
            if (mobileMenuBtn && mobileMenu) {
                console.log('Mobile menu elements found'); // Debug log
                
                mobileMenuBtn.addEventListener('click', function(e) {
                    console.log('Mobile menu button clicked'); // Debug log
                    e.preventDefault();
                    e.stopPropagation();
                    
                    mobileMenu.classList.toggle('active');
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.toggle('fa-bars');
                        icon.classList.toggle('fa-times');
                    }
                });
            } else {
                console.log('Mobile menu elements not found:', { 
                    btn: mobileMenuBtn, 
                    menu: mobileMenu 
                }); // Debug log
            }
        });

        // Create a marker icon once and reuse it
        const availableMarkerIcon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="
                width: 12px;
                height: 12px;
                background-color: #00C851;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 0 4px rgba(0,0,0,0.3);
            "></div>`,
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });

        const soldMarkerIcon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="
                width: 12px;
                height: 12px;
                background-color: #ff4444;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 0 4px rgba(0,0,0,0.3);
            "></div>`,
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });

        function createMarker(coordinates, properties) {
            try {
                if (!Array.isArray(coordinates) || coordinates.length !== 2) {
                    console.error('Invalid coordinates:', coordinates);
                    return null;
                }

                const icon = properties.status === "Sold" ? soldMarkerIcon : availableMarkerIcon;
                const marker = L.marker([coordinates[1], coordinates[0]], { 
                    icon,
                    interactive: true,
                    bubblingMouseEvents: false
                });
                
                marker.properties = properties;

                // Create popup content only when needed
                marker.bindPopup(() => createPopupContent(properties), {
                    closeButton: true,
                    closeOnClick: true,
                    autoClose: true,
                    className: document.body.classList.contains('dark-mode') ? 'dark-mode' : '',
                    maxWidth: 'auto'
                });

                // Add to cluster group instead of directly to map
                markerClusterGroup.addLayer(marker);
                return marker;
            } catch (error) {
                console.error('Error creating marker:', error);
                return null;
            }
        }

        // Add cleanup for event listeners
        window.addEventListener('beforeunload', () => {
            // Remove map event listeners
            if (map) {
                map.remove();
            }
            // Remove other event listeners
            document.querySelectorAll('.property-card').forEach(card => {
                card.replaceWith(card.cloneNode(true));
            });
        });

        // Add this helper function to parse location string
        function parseLocationString(locationString) {
            if (!locationString) return {};
            
            const parts = locationString.split(',').map(part => part.trim());
            const stateZipParts = parts[2]?.split(' ') || [];
            
            return {
                address: parts[0] || '',
                city: parts[1] || '',
                state: stateZipParts[0] || '',
                zipcode: stateZipParts[1] || '',
                country: parts[3] || ''
            };
        }
    </script>
</body>
</html> 